{% extends "incs/base.html" %} {% block title %} Account - Laundry And Fashion
{% endblock title %} {% block content %} 
{% include 'incs/modals/add_plan_modal.html' %}

<!-- Page content -->
<main class="content-wrapper">
  <div class="container pt-4 pt-lg-5 pb-5">
    <div class="row pt-sm-2 pt-md-3 pt-lg-0 pb-2 pb-sm-3 pb-md-4 pb-lg-5">
      <!-- Sidebar navigation that turns into offcanvas on screens < 992px wide (lg breakpoint) -->

      {% include 'incs/user_pages/sidebar.html' %}

      <!-- Dashboard content -->
      <div class="col-lg-9 pt-2 pt-xl-3">
        <!-- Header -->
        <div
          class="d-flex align-items-center justify-content-between gap-3 pb-3 mb-2 mb-md-3"
        >
          <h1 class="h2 mb-0">Dashboard</h1>
        </div>
        <!-- Stats -->
        <div class="row g-3 g-xl-4 pb-3 mb-2 mb-sm-3">
          <div class="col-md-12 col-sm-12" id="usage-stats">
            <div class="h-100 bg-warning-subtle rounded-4 text-center p-4">
              <h2 class="fs-sm pb-2 mb-1">Volume & Usage</h2>
              <div class="h2 pb-1 mb-2" id="units-used">Loading...</div>
              <div
                class="progress mb-3"
                role="progressbar"
                aria-valuemin="0"
                aria-valuemax="100"
              >
                <div
                  class="progress-bar bg-dark fw-medium rounded-pill"
                  id="usage-progress"
                  style="width: 0%"
                >
                  0%
                </div>
              </div>
              <button
                id="units-left"
                class="badge border-0 fs-xs text-info bg-info-subtle rounded-pill"
              >
                Track-usage
              </button>
            </div>
          </div>
          <!---->
        </div>

        <div class="border rounded-4 py-4 px-3 px-sm-4">
          <div>
            <div
              class="nav flex-nowrap align-items-center justify-content-between pb-1 mb-3"
            >
              <div class="d-flex align-items-center gap-3 me-4">
                <h1 class="h2 mb-1 mb-sm-2">Services Plans</h1>
                <!--<a class="nav-link animate-underline fs-base px-0" href="#newPlanModal" data-bs-toggle="modal">
                                    <i class="ci-plus fs-lg ms-n1 me-2"></i>
                                    <span class="animate-target badge text-bg-info rounded-pill">Add Plans</span>
                                  </a>-->
              </div>

              <button
                id="createPlanBtn"
                class="nav-link animate-underline fs-base px-0"
                href="#newPlanModal"
                data-bs-toggle="modal"
              >
                <i class="ci-plus fs-lg ms-n1 me-2"></i>
                <span class="animate-target badge text-bg-info rounded-pill"
                  >Add plans</span
                >
              </button>
            </div>

            <!---->
            <table class="table align-middle fs-sm mb-0 table-hover">
              <thead>
                <tr>
                  <th class="ps-0" scope="col">
                    <span class="fw-normal text-body">Plans</span>
                  </th>
                  <th class="d-none d-md-table-cell" scope="col">
                    <span class="fw-normal text-body">Amount</span>
                  </th>
                  <th class="text-end d-none d-sm-table-cell" scope="col">
                    <span class="fw-normal text-body">Volume</span>
                  </th>
                  <th class="text-end" scope="col">
                    <span class="fw-normal text-body">Action</span>
                  </th>
                </tr>
              </thead>
              <tbody class="product-list plans-container">
                <!-- Plans will be populated here -->
              </tbody>
            </table>
          </div>
        </div>

        <div class="card border-0 shadow">
          <div class="card-body">
            <h5 class="card-title mb-4">Service Summary</h5>
            <div class="row g-4">
              <!-- Pick Up Service -->
              <div class="col-12 col-md-6 col-lg-4">
                <div class="card h-100 border-0 shadow-sm">
                  <div class="card-body">
                    <h6 class="card-title d-flex align-items-center">
                      <i class="fas fa-box-open text-primary me-2"></i>
                      Pick Up
                    </h6>
                    <p class="card-text text-muted fs-sm mb-0">
                      We prepare your fabrics down, so you can come take them
                      away.
                    </p>
                  </div>
                </div>
              </div>

              <!-- Delivery Service -->
              <div class="col-12 col-md-6 col-lg-4">
                <div class="card h-100 border-0 shadow-sm">
                  <div class="card-body">
                    <h6 class="card-title d-flex align-items-center">
                      <i class="fas fa-truck text-primary me-2"></i>
                      Delivery
                    </h6>
                    <p class="card-text text-muted fs-sm mb-0">
                      We convey your fabrics to your destination.
                    </p>
                  </div>
                </div>
              </div>

              <!-- Measurement Service -->
              <div class="col-12 col-md-6 col-lg-4">
                <div class="card h-100 border-0 shadow-sm">
                  <div class="card-body">
                    <h6 class="card-title d-flex align-items-center">
                      <i class="fas fa-ruler-combined text-primary me-2"></i>
                      Take Measurement
                    </h6>
                    <p class="card-text text-muted fs-sm mb-0">
                      Our tailor comes over to measure and confirm fabrics.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!--<script src="./static/js/pages/account.js"></script>-->
<script>
    // account.js - Complete CRUD for Plans with Role-Based Access
document.addEventListener("DOMContentLoaded", () => {

        // Configuration and constants
    const CONFIG = {
        LOW_UNITS_THRESHOLD: 20,
        CURRENCY_OPTIONS: {
            style: 'currency',
            currency: 'NGN',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        },
        SELECTORS: {
            unitsUsed: 'units-used',
            usageProgress: 'usage-progress',
            unitsLeft: 'units-left',
            plansContainer: '.plans-container'
        }
    };

    // Utility functions
    const Utils = {
        /**
         * Safely get DOM element by ID with error handling
         */
        getElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element with ID '${id}' not found`);
            }
            return element;
        },

        /**
         * Safely query selector with error handling
         */
        querySelector(selector) {
            const element = document.querySelector(selector);
            if (!element) {
                console.warn(`Element with selector '${selector}' not found`);
            }
            return element;
        },

        /**
         * Safely access nested object properties
         */
        safeGet(obj, path, defaultValue = null) {
            try {
                return path.split('.').reduce((current, key) => current?.[key], obj) ?? defaultValue;
            } catch (error) {
                console.warn(`Error accessing property '${path}':`, error);
                return defaultValue;
            }
        },

        /**
         * Format currency with error handling
         */
        formatCurrency(amount) {
            try {
                if (typeof amount !== 'number' || isNaN(amount)) {
                    console.warn('Invalid amount for currency formatting:', amount);
                    return 'N/A';
                }
                return amount.toLocaleString('en-NG', CONFIG.CURRENCY_OPTIONS);
            } catch (error) {
                console.error('Error formatting currency:', error);
                return `â‚¦${amount.toFixed(2)}`;
            }
        },

        /**
         * Validate email address
         */
        validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(String(email).toLowerCase());
        },

        /**
         * Show loading spinner in container
         */
        showLoadingSpinner(container) {
            if (!container) return;
            container.innerHTML = `
                <div class="d-flex justify-content-center align-items-center p-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
        },

        /**
         * Clear container content
         */
        clearContainer(container) {
            if (container) {
                container.innerHTML = '';
            }
        }
    };

    /*
    // Usage Statistics Handler
    const UsageStatistics = {
        async fetch() {
            try {
                // Check if required functions exist
                if (!window.make_request) {
                    throw new Error('window.make_request function not available');
                }
                if (!window.apiUrl) {
                    throw new Error('window.apiUrl not defined');
                }

                console.log('Fetching usage statistics from:', `${window.apiUrl}/usage/statistics`);
                
                // Add timeout and retry logic
                const data = await this.makeRequestWithRetry(`${window.apiUrl}/usage/statistics`);
                // console.log('Usage statistics data received:', data);

                if (!data) {
                    // console.warn('No data received from server, using default values');
                    this.updateDisplay(this.getDefaultData());
                    return;
                }

                this.updateDisplay(data);
            } catch (error) {
                console.error('Error fetching usage statistics:', error);

                // Try to display default data instead of showing error
                this.updateDisplay(this.getDefaultData());
                this.handleError(error);
            }
        },

        async makeRequestWithRetry(url, maxRetries = 2, delay = 1000) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    // console.log(`Usage stats request attempt ${attempt}/${maxRetries}`);
                    
                    // Try with a simpler request first
                    const data = await window.make_request(url);
                    return data;
                } catch (error) {
                   // console.warn(`Attempt ${attempt} failed:`, error.message);
                    
                    if (attempt === maxRetries) {
                        throw error;
                    }
                    
                    // Wait before retry
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        },

        getDefaultData() {
            return {
                units_used: 0,
                total_units: 0,
                remaining_units: 0,
                usage_percentage: 0
            };
        },

        updateDisplay(data) {
            try {
                // Safely extract data with defaults
                const unitsUsed = Utils.safeGet(data, 'units_used', 0);
                const totalUnits = Utils.safeGet(data, 'total_units', 0);
                const remainingUnits = Utils.safeGet(data, 'remaining_units', 0);
                const usagePercentage = Utils.safeGet(data, 'usage_percentage', 0);

                // Update units used display
                const unitsUsedElement = Utils.getElement(CONFIG.SELECTORS.unitsUsed);
                if (unitsUsedElement) {
                    unitsUsedElement.textContent = `${unitsUsed} units used of ${totalUnits}`;
                }

                // Update progress bar
                this.updateProgressBar(usagePercentage);

                // Update remaining units
                this.updateRemainingUnits(remainingUnits);

            } catch (error) {
                console.error('Error updating usage display:', error);
            }
        },

        updateProgressBar(usagePercentage) {
            const usageProgressElement = Utils.getElement(CONFIG.SELECTORS.usageProgress);
            if (!usageProgressElement) return;

            try {
                const percentage = Math.round((usagePercentage || 0) * 100) / 100;
                const clampedPercentage = Math.max(0, Math.min(100, percentage));

                usageProgressElement.style.width = `${clampedPercentage}%`;
                usageProgressElement.textContent = `${clampedPercentage}%`;
                usageProgressElement.setAttribute('aria-valuenow', clampedPercentage);
            } catch (error) {
                console.error('Error updating progress bar:', error);
            }
        },

        updateRemainingUnits(remainingUnits) {
            const unitsLeftElement = Utils.getElement(CONFIG.SELECTORS.unitsLeft);
            if (!unitsLeftElement) return;

            try {
                const units = remainingUnits || 0;
                unitsLeftElement.textContent = `Remaining ${units} units`;

                // Handle low units warning
                if (units <= CONFIG.LOW_UNITS_THRESHOLD) {
                    unitsLeftElement.classList.add('text-danger');
                    
                    // Check if warning already exists to avoid duplicates
                    if (!unitsLeftElement.querySelector('.low-units-warning')) {
                        const warningSpan = document.createElement('span');
                        warningSpan.className = 'low-units-warning';
                        warningSpan.textContent = ' (Low units Alert. Please Recharge!)';
                        unitsLeftElement.appendChild(warningSpan);
                    }
                } else {
                    unitsLeftElement.classList.remove('text-danger');
                    const warningElement = unitsLeftElement.querySelector('.low-units-warning');
                    if (warningElement) {
                        warningElement.remove();
                    }
                }
            } catch (error) {
                console.error('Error updating remaining units:', error);
            }
        },

        handleError(error) {
            const errorMessage = `Error fetching usage statistics: ${error.message || 'Unknown error'}`;
            if (window.response_modal) {
                console.error(errorMessage);
                // window.response_modal(errorMessage);
            } else {
                console.error(errorMessage);
                // alert(errorMessage); // Fallback
            }
        }
    };*/
       // Usage Statistics Handler
    const UsageStatistics = {
       /*
        async fetch() {
            try {
                // Check if required functions exist
                if (!window.make_request) {
                    throw new Error('window.make_request function not available');
                }
                if (!window.apiUrl) {
                    throw new Error('window.apiUrl not defined');
                }

                console.log('Fetching usage statistics from:', `${window.apiUrl}/usage/statistics`);
                
                // Add timeout and retry logic
                const data = await this.makeRequestWithRetry(`${window.apiUrl}/usage/statistics`);
                // console.log('Usage statistics data received:', data);

                if (!data) {
                    // console.warn('No data received from server, using default values');
                    this.updateDisplay(this.getDefaultData());
                    return;
                }

                this.updateDisplay(data);
            } catch (error) {
                console.error('Error fetching usage statistics:', error);

                // Try to display default data instead of showing error
                this.updateDisplay(this.getDefaultData());
                this.handleError(error);
            }
        },

        async makeRequestWithRetry(url, maxRetries = 2, delay = 1000) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    // console.log(`Usage stats request attempt ${attempt}/${maxRetries}`);
                    
                    // Try with a simpler request first
                    const data = await window.make_request(url);
                    return data;
                } catch (error) {
                   // console.warn(`Attempt ${attempt} failed:`, error.message);
                    
                    if (attempt === maxRetries) {
                        throw error;
                    }
                    
                    // Wait before retry
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        },
        */
        async fetch() {
    try {
        console.log('Fetching usage statistics from:', `${window.apiUrl}/usage/statistics`);
        
        // Using direct fetch instead of make_request
        const response = await fetch(`${window.apiUrl}/usage/statistics`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        this.updateDisplay(data);
        
    } catch (error) {
        console.error('Error fetching usage statistics:', error);
        this.updateDisplay(this.getDefaultData());
        this.handleError(`Network error: ${error.message}`);
    }
},


        getDefaultData() {
            return {
                units_used: 0,
                total_units: 0,
                remaining_units: 0,
                usage_percentage: 0
            };
        },

        updateDisplay(data) {
            try {
                // Safely extract data with defaults
                const unitsUsed = Utils.safeGet(data, 'units_used', 0);
                const totalUnits = Utils.safeGet(data, 'total_units', 0);
                const remainingUnits = Utils.safeGet(data, 'remaining_units', 0);
                const usagePercentage = Utils.safeGet(data, 'usage_percentage', 0);

                // Update units used display
                const unitsUsedElement = Utils.getElement(CONFIG.SELECTORS.unitsUsed);
                if (unitsUsedElement) {
                    unitsUsedElement.textContent = `${unitsUsed} units used of ${totalUnits}`;
                }

                // Update progress bar
                this.updateProgressBar(usagePercentage);

                // Update remaining units
                this.updateRemainingUnits(remainingUnits);

            } catch (error) {
                console.error('Error updating usage display:', error);
            }
        },

        updateProgressBar(usagePercentage) {
            const usageProgressElement = Utils.getElement(CONFIG.SELECTORS.usageProgress);
            if (!usageProgressElement) return;

            try {
                const percentage = Math.round((usagePercentage || 0) * 100) / 100;
                const clampedPercentage = Math.max(0, Math.min(100, percentage));

                usageProgressElement.style.width = `${clampedPercentage}%`;
                usageProgressElement.textContent = `${clampedPercentage}%`;
                usageProgressElement.setAttribute('aria-valuenow', clampedPercentage);
            } catch (error) {
                console.error('Error updating progress bar:', error);
            }
        },

        updateRemainingUnits(remainingUnits) {
            const unitsLeftElement = Utils.getElement(CONFIG.SELECTORS.unitsLeft);
            if (!unitsLeftElement) return;

            try {
                const units = remainingUnits || 0;
                unitsLeftElement.textContent = `Remaining ${units} units`;

                // Handle low units warning
                if (units <= CONFIG.LOW_UNITS_THRESHOLD) {
                    unitsLeftElement.classList.add('text-danger');
                    
                    // Check if warning already exists to avoid duplicates
                    if (!unitsLeftElement.querySelector('.low-units-warning')) {
                        const warningSpan = document.createElement('span');
                        warningSpan.className = 'low-units-warning';
                        warningSpan.textContent = ' (Low units Alert. Please Recharge!)';
                        unitsLeftElement.appendChild(warningSpan);
                    }
                } else {
                    unitsLeftElement.classList.remove('text-danger');
                    const warningElement = unitsLeftElement.querySelector('.low-units-warning');
                    if (warningElement) {
                        warningElement.remove();
                    }
                }
            } catch (error) {
                console.error('Error updating remaining units:', error);
            }
        },

        handleError(error) {
            const errorMessage = `Error fetching usage statistics: ${error.message || 'Unknown error'}`;
            if (window.response_modal) {
                console.error(errorMessage);
                // window.response_modal(errorMessage);
            } else {
                console.error(errorMessage);
                // alert(errorMessage); // Fallback
            }
        }
    };

    // ... existing configuration and utility functions ...

    // Plans Management (CRUD Implementation)
    const PlansManager = {
        isAdmin: false,
        addPlanModal: null,
        editPlanModal: null,

        init() {
            // Check admin status
            const token = localStorage.getItem('access_token');
            const userRoles = window.getRolesFromDecodedToken(token);
            this.isAdmin = userRoles.includes('admin');

            this.container = Utils.querySelector(CONFIG.SELECTORS.plansContainer);
            if (!this.container) return;

            // Initialize modals
            this.initModals();
            
            // Conditionally show add plan button
            this.toggleAdminFeatures();
            
            // Fetch and render plans
            this.fetchPlans();
        },

        initModals() {
            // Add plan modal
            const addModalEl = document.getElementById('newPlanModal');
            if (addModalEl) {
                this.addPlanModal = new bootstrap.Modal(addModalEl);
                document.getElementById('addPlanForm')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.createPlan();
                });
            }

            // Edit plan modal
            const editModalEl = document.getElementById('editPlanModal');
            if (editModalEl) {
                this.editPlanModal = new bootstrap.Modal(editModalEl);
                document.getElementById('editPlanForm')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.updatePlan();
                });
            }
        },

        toggleAdminFeatures() {
            // Show/hide add plan button
            const addPlanBtn = document.getElementById('createPlanBtn');
            if (addPlanBtn) {
                addPlanBtn.style.display = this.isAdmin ? 'block' : 'none';
            }
        },

        async fetchPlans() {
            try {
                Utils.showLoadingSpinner(this.container);
                
                const response = await fetch(`${window.apiUrl}/plans`, {
                    headers: { Authorization: `Bearer ${localStorage.getItem('access_token')}` }
                });
                
                if (!response.ok) throw new Error('Failed to fetch plans');
                
                const data = await response.json();
                Utils.clearContainer(this.container);
                
                if (!Array.isArray(data.plans) || data.plans.length === 0) {
                    this.container.innerHTML = '<tr><td colspan="4" class="text-center py-4">No plans available</td></tr>';
                    return;
                }

                this.renderPlans(data.plans);
                this.attachEventListeners();

            } catch (error) {
                console.error('Error fetching plans:', error);
                this.container.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-4 text-danger">
                            Error loading plans: ${error.message}
                        </td>
                    </tr>
                `;
            }
        },

        renderPlans(plans) {
            plans.forEach((plan, index) => {
                const planRow = this.createPlanRow(plan, index);
                this.container.insertAdjacentHTML('beforeend', planRow);
            });
        },

        /*
        createPlanRow(plan, index) {
            const planId = Utils.safeGet(plan, 'id', `plan-${index}`);
            const planName = Utils.safeGet(plan, 'name', 'Unnamed Plan');
            const planAmount = Utils.safeGet(plan, 'amount', 0);
            const planUnits = Utils.safeGet(plan, 'units', 'N/A');
            const planDescription = Utils.safeGet(plan, 'description', '');

            return `
                <tr data-plan-id="${planId}">
                    <td class="py-3 ps-0">
                        <div class="d-flex align-items-start align-items-md-center">
                            <div class="ratio bg-body-secondary rounded-2 overflow-hidden flex-shrink-0" style="width: 66px">
                                <img src="static/img/account/products/03.jpg" 
                                     class="hover-effect-target" 
                                     alt="Plan image"
                                     onerror="this.style.display='none'">
                            </div>
                            <div class="ps-2 ms-1">
                                <h6 class="product mb-1 mb-md-0">
                                    <span class="fs-sm fw-medium">${this.escapeHtml(planName)}</span>
                                </h6>
                                <div class="fs-xs text-muted">${this.escapeHtml(planDescription)}</div>
                            </div>
                        </div>
                    </td>
                    <td class="d-none d-md-table-cell py-3">
                        <span class="badge fs-xs text-info bg-info-subtle rounded-pill">
                            ${Utils.formatCurrency(planAmount)}
                        </span>
                    </td>
                    <td class="text-end d-none d-sm-table-cell py-3">${this.escapeHtml(planUnits)}</td>
                    <td class="text-end py-3">
                        ${this.isAdmin ? `
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-info edit-plan-btn" 
                                        data-plan-id="${planId}">
                                    <i class="fi-edit me-1"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-plan-btn ms-1" 
                                        data-plan-id="${planId}">
                                    <i class="fi-trash me-1"></i>
                                </button>
                            </div>
                        ` : `
                            <button class="btn btn-sm btn-dark rounded-pill subscribe-btn" 
                                    data-plan-id="${planId}"
                                    type="button">
                                Recharge
                            </button>
                        `}
                    </td>
                </tr>
            `;
        }, */

          createPlanRow(plan, index) {
            const planId = Utils.safeGet(plan, 'id', `plan-${index}`);
            const planName = Utils.safeGet(plan, 'name', 'Unnamed Plan');
            const planAmount = Utils.safeGet(plan, 'amount', 0);
            const planUnits = Utils.safeGet(plan, 'units', 'N/A');
            const planDescription = Utils.safeGet(plan, 'description', '');

            return `
                <tr data-plan-id="${planId}">
                    <td class="py-3 ps-0">
                        <div class="d-flex align-items-start align-items-md-center">
                            <div class="ratio bg-body-secondary rounded-2 overflow-hidden flex-shrink-0" style="width: 66px">
                                <img src="static/img/account/products/03.jpg" 
                                     class="hover-effect-target" 
                                     alt="Plan image"
                                     onerror="this.style.display='none'">
                            </div>
                            <div class="ps-2 ms-1">
                                <h6 class="product mb-1 mb-md-0">
                                    <span class="fs-sm fw-medium">${this.escapeHtml(planName)}</span>
                                </h6>
                                <div class="fs-xs text-muted">${this.escapeHtml(planDescription)}</div>
                            </div>
                        </div>
                    </td>
                    <td class="d-none d-md-table-cell py-3">
                        <span class="badge fs-xs text-info bg-info-subtle rounded-pill">
                            ${Utils.formatCurrency(planAmount)}
                        </span>
                    </td>
                    <td class="text-end d-none d-sm-table-cell py-3">${this.escapeHtml(planUnits)}</td>
                    <td class="text-end py-3">
                        ${this.isAdmin ? `
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-info edit-plan-btn" 
                                        data-plan-id="${planId}">
                                    <i class="fi-edit me-1"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-plan-btn ms-1" 
                                        data-plan-id="${planId}">
                                    <i class="fi-trash me-1"></i>
                                </button>
                            </div>
                        ` : ''}
                        <!-- Subscribe button shown to ALL users (including admins) -->
                        <button class="btn btn-sm btn-dark rounded-pill subscribe-btn mt-1 mt-sm-0" 
                                data-plan-id="${planId}"
                                type="button">
                            Recharge
                        </button>
                    </td>
                </tr>
            `;
        },

        attachEventListeners() {
            if (!this.container) return;

            // Edit plan button
            this.container.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-plan-btn');
                if (editBtn) {
                    e.preventDefault();
                    this.openEditModal(editBtn.dataset.planId);
                }
            });

            // Delete plan button
            this.container.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-plan-btn');
                if (deleteBtn) {
                    e.preventDefault();
                    this.confirmDeletePlan(deleteBtn.dataset.planId);
                }
            });

            // Subscribe button (for non-admins)
            this.container.addEventListener('click', (e) => {
                const subscribeBtn = e.target.closest('.subscribe-btn');
                if (subscribeBtn) {
                    e.preventDefault();
                    PaymentHandler.subscribe(
                        subscribeBtn.dataset.planId, 
                        null, 
                        subscribeBtn
                    );
                }
            });
        },

        async openEditModal(planId) {
            try {
                const response = await fetch(`${window.apiUrl}/plans/${planId}`, {
                    headers: { Authorization: `Bearer ${localStorage.getItem('access_token')}` }
                });
                
                if (!response.ok) throw new Error('Failed to fetch plan details');
                
                const plan = await response.json();
                
                // Populate form
                document.getElementById('editPlanId').value = plan.id;
                document.getElementById('editPlanName').value = plan.name;
                document.getElementById('editPlanDescription').value = plan.description || '';
                document.getElementById('editPlanPrice').value = plan.amount;
                document.getElementById('editPlanVolume').value = plan.units;
                
                // Show modal
                if (this.editPlanModal) {
                    this.editPlanModal.show();
                }

            } catch (error) {
                console.error('Error opening edit modal:', error);
                window.response_modal(`Error: ${error.message}`);
            }
        },

        confirmDeletePlan(planId) {
            if (!confirm('Are you sure you want to delete this plan? This action cannot be undone.')) return;
            this.deletePlan(planId);
        },

        async createPlan() {
            try {
                const planData = {
                    name: document.getElementById('planName').value,
                    description: document.getElementById('planDescription').value,
                    amount: parseFloat(document.getElementById('planPrice').value),
                    units: parseInt(document.getElementById('planVolume').value)
                };

                const response = await fetch(`${window.apiUrl}/plans`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify(planData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to create plan');
                }

                // Close modal and refresh
                if (this.addPlanModal) this.addPlanModal.hide();
                this.fetchPlans();
                window.response_modal('Plan created successfully!');

            } catch (error) {
                console.error('Error creating plan:', error);
                window.response_modal(`Error: ${error.message}`);
            }
        },

        async updatePlan() {
            try {
                const planId = document.getElementById('editPlanId').value;
                const planData = {
                    name: document.getElementById('editPlanName').value,
                    description: document.getElementById('editPlanDescription').value,
                    amount: parseFloat(document.getElementById('editPlanPrice').value),
                    units: parseInt(document.getElementById('editPlanVolume').value)
                };

                const response = await fetch(`${window.apiUrl}/plans/${planId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify(planData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update plan');
                }

                // Close modal and refresh
                if (this.editPlanModal) this.editPlanModal.hide();
                this.fetchPlans();
                window.response_modal('Plan updated successfully!');

            } catch (error) {
                console.error('Error updating plan:', error);
                window.response_modal(`Error: ${error.message}`);
            }
        },

        async deletePlan(planId) {
            try {
                const response = await fetch(`${window.apiUrl}/plans/${planId}`, {
                    method: 'DELETE',
                    headers: { 
                        Authorization: `Bearer ${localStorage.getItem('access_token')}` 
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to delete plan');
                }

                // Remove from UI
                const planRow = document.querySelector(`tr[data-plan-id="${planId}"]`);
                if (planRow) planRow.remove();
                
                window.response_modal('Plan deleted successfully!');

            } catch (error) {
                console.error('Error deleting plan:', error);
                window.response_modal(`Error: ${error.message}`);
            }
        },

        escapeHtml(text) {
            if (!text) return '';
            return text.toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
    };

    // Payment Handler
    const PaymentHandler = {
        /*
        async subscribe(planId, email, button) {
            if (!planId) {
                console.error('Plan ID is required for subscription');
                return;
            }

            try {
                this.setButtonLoading(button, true);
                console.log('Initiating payment for plan:', planId);

                // Check if make_request is available, fallback to fetch
                let response;
                const requestBody = { email: email };
                
                if (window.make_request && typeof window.make_request === 'function') {
                    try {
                        response = await window.make_request(`${window.apiUrl}/payment/${planId}/paystack`, {
                            method: "POST",
                            headers: {
                                'Content-Type': 'application/json',
                                'Client-Callback-Url': window.location.href,
                            },
                            body: JSON.stringify(requestBody),
                        });
                        // console.log(`response from plan payments: ${response}`);

                    } catch (makeRequestError) {
                        console.warn('make_request failed, falling back to fetch:', makeRequestError);
                        // Fallback to regular fetch
                        const fetchResponse = await fetch(`${window.apiUrl}/payment/${planId}/paystack`, {
                            method: "POST",
                            headers: {
                                'Content-Type': 'application/json',
                                'Client-Callback-Url': window.location.href,
                            },
                            body: JSON.stringify(requestBody),
                        });
                        
                        if (!fetchResponse.ok) {
                            // window.response_modal(JSON.stringify(makeRequestError) || "Error processing payment");
                            // throw new Error(`HTTP error! status: ${fetchResponse.status}`);
                            console.error(`Error processing payment. HTTP error! status: ${fetchResponse.status}`);
                            throw new Error(`Could not process payment at the moment, pls try again/inform admin about this.`);
                        }
                        response = await fetchResponse.json();
                    }
                } else {
                    // Use fetch directly if make_request is not available
                    const fetchResponse = await fetch(`${window.apiUrl}/payment/${planId}/paystack`, {
                        method: "POST",
                        headers: {
                            'Content-Type': 'application/json',
                            'Client-Callback-Url': window.location.href,
                        },
                        body: JSON.stringify(requestBody),
                    });
                    
                    if (!fetchResponse.ok) {
                        throw new Error(`HTTP error! status: ${fetchResponse.status}`);
                    }
                    response = await fetchResponse.json();
                }

                this.setButtonLoading(button, false);

                if (response && response.success && response.redirect) {
                    console.log('Payment initiated successfully, redirecting...');
                    window.location.href = response.redirect;
                } else {
                    const errorMessage = Utils.safeGet(response.error, 'error', 'Error processing payment');
                    console.error('Payment error:', errorMessage);
                    this.handleError(errorMessage);
                }

            } catch (error) {
                console.error('Subscription error:', error);
                this.setButtonLoading(button, false);
                this.handleError(`Error: ${error.message || 'Unknown error occurred'}`);
            }

            // 
        //     if (response.success) {
        //     window.location.href = response.redirect;
        // } else {
        //     button.innerHTML = 'Subscribe'; // Reset button text
        //     window.response_modal(response.error || "Error processing payment");
        // }
        // 
        }, */

        async subscribe(planId, email, button) {
    try {
        this.setButtonLoading(button, true);
        
        // Get user email from token
        const token = localStorage.getItem('access_token');
        if (!token) throw new Error('User not authenticated');
        
        const payload = JSON.parse(atob(token.split('.')[1]));
        if (!payload.email) throw new Error('User email not found in token');
        
        const requestBody = { 
            email: payload.email,
            metadata: {
                userId: payload.id,
                userAgent: navigator.userAgent,
                timestamp: new Date().toISOString()
            }
        };
        
        const response = await fetch(`${window.apiUrl}/payment/${planId}/paystack`, {
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                'Client-Callback-Url': window.location.href,
            },
            body: JSON.stringify(requestBody),
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error: ${response.status}`);
        }

        const result = await response.json();
        this.setButtonLoading(button, false);

        if (result.success && result.redirect) {
            window.location.href = result.redirect;
        } else {
            throw new Error(result.error || 'Payment processing failed');
        }

    } catch (error) {
        console.error('Subscription error:', error);
        this.setButtonLoading(button, false);
        this.handleError(`Payment failed: ${error.message || 'Please try again later'}`);
    }
},

        setButtonLoading(button, isLoading) {
            if (!button) return;

            if (isLoading) {
                button.disabled = true;
                button.innerHTML = `
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    Loading...
                `;
            } else {
                button.disabled = false;
                button.innerHTML = 'Recharge';
            }
        },

        handleError(message) {
            if (window.response_modal) {
                window.response_modal(message);
            } else {
                console.error(message);
                // alert(message);
            }
        }
    };

    // URL Parameter Handler
    const URLHandler = {
        getQueryParams() {
            try {
                const params = new URLSearchParams(window.location.search);
                return {
                    status: params.get('status'),
                    reference: params.get('reference') || params.get('trxref')
                };
            } catch (error) {
                console.error('Error parsing URL parameters:', error);
                return {};
            }
        },

        removeQueryParameters() {
            try {
                const url = window.location.href;
                const baseUrl = url.split('?')[0];
                window.history.replaceState({}, document.title, baseUrl);
            } catch (error) {
                console.error('Error removing query parameters:', error);
            }
        },

        async handlePaymentCallback() {
            const queryParams = this.getQueryParams();
            
            if (!queryParams.reference) {
                return; // No payment callback to handle
            }

            try {
                if (window.response_modal) {
                    window.response_modal('Verifying your transaction, please wait...');
                }

                const response = await fetch(`${window.apiUrl}/payment/callback/paystack?reference=${queryParams.reference}`);
                
                // if (!response.ok) {
                //     // throw new Error(`HTTP error! status: ${response.status}`);
                //     throw new Error(`HTTP error! status: ${response.status}`);
                // }

                const result = await response.json();
                console.log('Payment verification result:', result);

                const message = result.success 
                    ? (result.message || "Transaction completed successfully!")
                    : (result.error || "Error processing transaction.");

                if (window.response_modal) {
                    window.response_modal(message);
                }

                this.removeQueryParameters();

            } catch (error) {
                console.error('Payment callback error:', error);
                const errorMessage = `Error: ${error.error || error.error || "Unknown error occurred."}`;
                if (window.response_modal) {
                    window.response_modal(errorMessage);
                }
            }
        }
    };
    
    // Application Initialization
    const App = {
        async init() {
            try {
                // Initialize components
                await UsageStatistics.fetch();
                PlansManager.init();
                await URLHandler.handlePaymentCallback();
            } catch (error) {
                console.error('Application initialization error:', error);
            }
        }
    };

    // Start the application
    App.init();
});

</script>
{% endblock content %}
